#!/bin/bash
[ $# -ne 1 ]&&exit 1;d="$1";o="$d.csv";whois "$d"|awk -v OFS="," 'BEGIN{sec="";order[1]="Name";order[2]="Organization";order[3]="Street";order[4]="City";order[5]="State/Province";order[6]="Postal Code";order[7]="Country";order[8]="Phone";order[9]="Phone Ext:";order[10]="Fax";order[11]="Fax Ext:";order[12]="Email"}function reset(){for(i=1;i<=12;i++)f[order[i]]=""}function dump(p,i,v){for(i=1;i<=12;i++){v=f[order[i]];if(order[i]=="Street")v=v" ";printf "%s %s%s%s",p,order[i],OFS,v;if(!(p=="Tech"&&i==12))printf "\n"}}/^Registrant([[:space:]]|:| Information)/{if(sec!="")dump(sec);sec="Registrant";reset();next}/^Admin([[:space:]]|:| Information)/{if(sec!="")dump(sec);sec="Admin";reset();next}/^Tech([[:space:]]|:| Information)/{if(sec!="")dump(sec);sec="Tech";reset();next}sec!=""&&/^[ \t]*[^:]+:/{line=$0;sub(/^[ \t]*/,"",line);split(line,a,":");k=a[1];sub(/^[^:]+:[ \t]*/,"",$0);if(k in f)f[k]=$0}END{if(sec!="")dump(sec)}' > "$o"

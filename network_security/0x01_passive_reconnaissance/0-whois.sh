#!/usr/bin/env bash
[ $# -ne 1 ]&&exit 1;d="$1";o="$d.csv";whois "$d"|awk -v OFS="," 'BEGIN{s="";n=0}/^Registrant/{s="R";next}/^Admin/{s="A";next}/^Tech/{s="T";next}function emit(f,v,  p){p=(s=="R"?"Registrant ":(s=="A"?"Admin ":"Tech "));gsub(/\r/,"",v);if(f~/Street$/){v=v" "}if(f=="Phone Ext:"||f=="Fax Ext:"){v=""}out[++n]=p f OFS v} (s=="R"||s=="A"||s=="T")&&/Name:[ \t]*/&&!/Fax|Phone/ {sub(/^.*Name:[ \t]*/,"");emit("Name",$0)} (s=="R"||s=="A"||s=="T")&&/Organization:[ \t]*/ {sub(/^.*Organization:[ \t]*/,"");emit("Organization",$0)} (s=="R"||s=="A"||s=="T")&&/Street:[ \t]*/ {sub(/^.*Street:[ \t]*/,"");emit("Street",$0)} (s=="R"||s=="A"||s=="T")&&/City:[ \t]*/ {sub(/^.*City:[ \t]*/,"");emit("City",$0)} (s=="R"||s=="A"||s=="T")&&/State\/Province:[ \t]*/ {sub(/^.*State\/Province:[ \t]*/,"");emit("State/Province",$0)} (s=="R"||s=="A"||s=="T")&&/Postal Code:[ \t]*/ {sub(/^.*Postal Code:[ \t]*/,"");emit("Postal Code",$0)} (s=="R"||s=="A"||s=="T")&&/Country:[ \t]*/ {sub(/^.*Country:[ \t]*/,"");emit("Country",$0)} (s=="R"||s=="A"||s=="T")&&/Phone Ext:[ \t]*/ {emit("Phone Ext:","")} (s=="R"||s=="A"||s=="T")&&/Phone:[ \t]*/&&!/Phone Ext/ {sub(/^.*Phone:[ \t]*/,"");emit("Phone",$0)} (s=="R"||s=="A"||s=="T")&&/Fax Ext:[ \t]*/ {emit("Fax Ext:","")} (s=="R"||s=="A"||s=="T")&&/Fax:[ \t]*/&&!/Fax Ext/ {sub(/^.*Fax:[ \t]*/,"");emit("Fax",$0)} (s=="R"||s=="A"||s=="T")&&/Email:[ \t]*/ {sub(/^.*Email:[ \t]*/,"");emit("Email",$0)} END{for(i=1;i<=n;i++){if(i<n)printf "%s\n",out[i]; else printf "%s",out[i]}}' > "$o"
